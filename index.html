<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>イラスト見積もりフォーム</title>
  <style>
    /*全体のスタイル設定*/
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f4f4f9;
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    /*フォーム本体のコンテナ装飾*/
    .container {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 700px;
    }

    /*送信完了の表示*/
    .complete {
      text-align: center;
      padding: 40px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: auto;
    }
    h2, h3 { color: #333; }
    h3 {
      background-color: #eef1f9;
      padding: 10px;
      border-left: 5px solid #446dff;
      font-size: 1.1em;
      margin-top: 30px;
    }

    /*ラベルと入力欄のレイアウト*/
    label { display: block; margin: 6px 0; color: #222; }
    input[type="text"], input[type="email"], textarea {
      width: 100%; padding: 8px; margin-top: 6px; margin-bottom: 20px;
      border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
    }
    input[type="file"] { margin-bottom: 20px; }

    /*送信ボタン*/
    button {
      background-color: #446dff; color: white; padding: 12px 20px;
      border: none; border-radius: 6px; font-size: 1em; width: 100%;
      cursor: pointer; margin-top: 20px;
    }
    button[disabled] {
      background-color: #888;
      cursor: not-allowed;
    }
    button:hover:not([disabled]) { background-color: #2c52d2; }

    /*合計金額の表示スタイル*/
    .total { font-size: 1.4em; color: #2c7a00; font-weight: bold; text-align: center; margin-top: 20px; }

    /*プレビュー画像の表示スタイル*/
    .preview img {
      max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 6px;
    }

    /*右の固定プレビューパネルのスタイル*/
    #previewPanel {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 250px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      font-size: 14px;
    }
    #previewPanel h4 {
      margin-top: 0;
    }

    #previewPanel .preview-total-highlight {
    font-size: 1.4em;
    color: #2c7a00;
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
    }
    

  </style>
</head>
<body>
  <div class="container" id="formContainer">
    <h2>イラスト見積もりフォーム</h2>
    <form id="estimateForm" onsubmit="submitForm(event)">

      <!--希望のイラスト選択（ラジオボタン）-->
      <h3>ご希望のイラストタイプ</h3>
      <div id="typePreview" class="preview"></div>
      <label><input type="radio" name="type" value="5000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 顔アップ（5,000円）</label>
      <label><input type="radio" name="type" value="8000" data-img="./images/559117789085565435.jpg"> バストアップ（8,000円）</label>
      <label><input type="radio" name="type" value="10000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 膝上（10,000円）</label>
      <label><input type="radio" name="type" value="13000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 全身（13,000円）</label>
      <label><input type="radio" name="type" value="40000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> Live2D用イラストパーツ分け（40,000円）</label>
      <label><input type="radio" name="type" value="25000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> Live2Dバストアップ（25,000円）</label>
      <label><input type="radio" name="type" value="15000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> キャラ・衣装デザイン（15,000円）</label>

      <!--イラストタイプの画像表示-->
      <div id="typeImageBelowOptions" class="preview"></div>

      <!--追加オプション選択（チェックボックス）-->
      <h3>追加オプション（複数選択可）</h3>
      <div id="optionPreview" class="preview"></div>
      <label><input type="checkbox" class="option" value="5000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 背景（5,000円）</label>
      <label><input type="checkbox" class="option" value="15000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 細かい背景（15,000円）</label>
      <label><input type="checkbox" class="option" value="5000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 細かい装飾（5,000円）</label>
      <label><input type="checkbox" class="option" value="5000" data-img="./images/fec976d1-b412-4286-b968-e8b672f86fd5.png"> 動物・大きめアクセ（5,000円）</label>
      <label><input type="checkbox" class="option" value="10000"> 追加衣装（1着ごと10,000円）</label>
      <label><input type="checkbox" class="option" value="5000"> 商用利用（5,000円）</label>

      <!--追加オプションの画像表示-->
      <div class="total">合計金額：¥<span id="total">0</span></div>

      <!--ユーザー情報入力-->
      <h3>ご連絡先</h3>
      <span style="color:#FF0000; font-size: 12px;">※お名前とメールアドレスは必須です。</span>
      <input type="text" id="name" placeholder="お名前" required>
      <input type="email" id="email" placeholder="メールアドレス" required>

      <h3>ご要望</h3>
      <textarea id="note" placeholder="ご要望など" rows="4"></textarea>

      <h3>参考画像（添付）</h3>
      <input type="file" id="imageFile" accept="image/*">

      <button id="submitBtn" type="submit">送信</button>
    </form>
  </div>

   <!--送信後のメッセージ-->
  <div id="completeMessage" class="complete" style="display:none;">
    <h2>送信が完了しました！</h2>
    <p>ありがとうございました。ブラウザを閉じてください。</p>
    <button onclick="window.close()">ブラウザを閉じる</button>
  </div>

  <!--右のプレビューが選択内容と金額がリアルタイムで連動-->
  <div id="previewPanel">
    <h4>プレビュー</h4>
    <p><strong>イラストタイプ:</strong> <span id="previewType">未選択</span></p>
    <p><strong>追加オプション:</strong> <span id="previewOptions">なし</span></p>
    <p><strong>合計金額： </strong>  <span id="previewTotal" class="preview-total-highlight">0</span></p>

  </div>

  <!--各種要素の取得-->
 <script>
  const radios = document.querySelectorAll('input[name="type"]');
  const checkboxes = document.querySelectorAll('.option');
  const totalEl = document.getElementById('total');
  const submitBtn = document.getElementById('submitBtn');
  const optionPreview = document.getElementById('optionPreview');
  const typePreview = document.getElementById('typeImageBelowOptions');

  /*金額計算とプレビューパネルの更新*/
  function calculateTotal() {
    let total = 0;
    const selected = document.querySelector('input[name="type"]:checked');
    if (selected) total += parseInt(selected.value);
    checkboxes.forEach(opt => {
      if (opt.checked) total += parseInt(opt.value);
    });
    totalEl.textContent = total.toLocaleString();
    updatePreviewPanel();
  }

  /*イラストタイプの画像を表示*/
  function updateTypePreview() {
    const selected = document.querySelector('input[name="type"]:checked');
    const existing = document.getElementById("typeImagePreview");
    if (existing) existing.remove();

    if (selected && selected.dataset.img) {
      const img = document.createElement("img");
      img.src = selected.dataset.img;
      img.alt = "タイプ画像";
      img.id = "typeImagePreview";
      img.style.maxWidth = "100%";
      img.style.maxHeight = "200px";
      img.style.marginTop = "10px";
      img.style.borderRadius = "6px";

      const lastTypeLabel = Array.from(radios).slice(-1)[0].closest("label");
      lastTypeLabel.insertAdjacentElement('afterend', img);
    }
  }

  /*追加オプション画像の表示（チェックボックスの最後の下）*/
  function updateOptionPreview() {
    /*既存の画像を削除*/
    const existingOptions = document.querySelectorAll('.optionImagePreview');
    existingOptions.forEach(el => el.remove());

    /*チェックされたオプションに対する画像の追加*/
    const lastOptionLabel = Array.from(checkboxes).slice(-1)[0].closest("label");

    checkboxes.forEach(opt => {
      if (opt.checked && opt.dataset.img) {
        const img = document.createElement("img");
        img.src = opt.dataset.img;
        img.alt = "オプション画像";
        img.className = "optionImagePreview";
        img.style.maxWidth = "100%";
        img.style.maxHeight = "200px";
        img.style.marginTop = "10px";
        img.style.borderRadius = "6px";
        lastOptionLabel.insertAdjacentElement('afterend', img);
      }
    });
  }

  /*プレビューパネルの更新*/
function updatePreviewPanel() {
  const selected = document.querySelector('input[name="type"]:checked');
  const selectedOptions = Array.from(document.querySelectorAll('.option:checked'));
  const options = selectedOptions.map(opt => opt.parentElement.textContent.trim());
  document.getElementById("previewType").textContent = selected ? selected.parentElement.textContent.trim() : "未選択";
  document.getElementById("previewOptions").textContent = options.length ? options.join(", ") : "なし";

  /*ここを修正：¥マークを含めて表示*/
  document.getElementById("previewTotal").textContent = "¥" + totalEl.textContent;
}


  /*フォーム送信処理*/
 function submitForm(event) {
  event.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const note = document.getElementById("note").value;
  const total = document.getElementById("total").textContent;
  const selectedType = document.querySelector('input[name="type"]:checked');
  const selectedOptions = Array.from(document.querySelectorAll('.option:checked'));

  if (!name || !email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alert("お名前と正しいメールアドレスを入力してください。");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "送信中...";

  const data = {
    name,
    email,
    note,
    total,
    typeLabel: selectedType ? selectedType.parentElement.textContent.trim() : "",
    optionLabels: selectedOptions.map(opt => opt.parentElement.textContent.trim()),
    image: null
  };

  const file = document.getElementById("imageFile").files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      data.image = e.target.result;
      sendToGAS(data);
    };
    reader.readAsDataURL(file);
  } else {
    sendToGAS(data);
  }
}

// 外に定義（submitFormの外）
function sendToGAS(data) {
  fetch("https://script.google.com/macros/s/AKfycbwnVXHI58mr87AiidQsyIuZYHDzPeZGyY8TDebfOPs-H6fzJrRxX-_H7UNuEPsjunyH/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(async res => {
    console.log("レスポンスステータス:", res.status);
    const resText = await res.text();
    console.log("レスポンステキスト:", resText);

    if (res.ok) {
      document.getElementById("formContainer").style.display = "none";
      document.getElementById("completeMessage").style.display = "block";
    } else {
      alert("送信に失敗しました。ステータスコード: " + res.status);
    }
  })
  .catch(error => {
    console.error("Fetchエラー:", error);  // ← ここで詳細ログ
    alert("通信エラー: " + error.message);
  });
}




  /*イベント設定*/
  radios.forEach(r => r.addEventListener('change', () => {
    calculateTotal();
    updateTypePreview();
  }));

  checkboxes.forEach(c => c.addEventListener('change', () => {
    calculateTotal();
    updateOptionPreview();
  }));

  /*初期処理*/
  document.addEventListener('DOMContentLoaded', () => {
    calculateTotal();
    updateTypePreview();
    updateOptionPreview();
  });
</script>

</body>
</html>


